---
mode: "agent"
tools: ["codebase"]
description: "为任意语言或框架创建优化的多阶段 Dockerfile。"
---

你的目标是帮助我编写高效的多阶段 Dockerfile，遵循最佳实践，生成更小且更安全的容器镜像。

## 多阶段结构

- 使用构建阶段处理编译、依赖安装以及其他构建时操作。
- 使用单独的运行时阶段，仅包含运行应用所需的内容。
- 仅从构建阶段复制运行阶段所需的工件。
- 使用有意义的阶段名称，并搭配 `AS` 关键字（例如 `FROM node:18 AS builder`）。
- 以逻辑顺序排列阶段：依赖 → 构建 → 测试 → 运行时。

## 基础镜像

- 尽可能使用官方且精简的基础镜像。
- 指定精确的版本标签以保证构建可复现（例如 `python:3.11-slim` 而非 `python`）。
- 运行阶段在适用时可考虑使用 distroless 镜像。
- 当应用兼容时，可采用基于 Alpine 的镜像以减小体积。
- 确保运行时镜像仅包含最必要的依赖。

## 层优化

- 安排命令顺序以最大化层缓存命中率。
- 将变更频繁的命令（如代码更新）置于变更较少的命令（如依赖安装）之后。
- 使用 `.dockerignore` 阻止无关文件进入构建上下文。
- 通过 `&&` 合并相关的 `RUN` 命令以减少层数。
- 如果需要设置权限，考虑使用 `COPY --chown` 一步完成。

## 安全实践

- 避免以 root 身份运行容器，使用 `USER` 指令指定普通用户。
- 从最终镜像中移除构建工具和不必要的软件包。
- 对最终镜像执行漏洞扫描。
- 设置严格的文件权限。
- 利用多阶段构建避免在最终镜像中包含构建密钥。

## 性能考量

- 使用构建参数处理不同环境间可能变化的配置。
- 通过按变更频率从低到高排列层来利用构建缓存。
- 在可行时为构建步骤引入并行化。
- 设置合适的环境变量（如 `NODE_ENV=production`）以优化运行时行为。
- 使用 `HEALTHCHECK` 指令为应用配置恰当的健康检查。


---
mode: "agent"
description: "分析 Azure 资源运行状况，根据日志和遥测数据诊断问题，并为已发现的问题创建修复计划。"
---

# Azure 资源运行状况和问题诊断

此工作流分析特定的 Azure 资源，以评估其运行状况，使用日志和遥测数据诊断潜在问题，并为发现的任何问题制定全面的修复计划。

## 先决条件

- 已配置并验证 Azure MCP 服务器
- 已识别目标 Azure 资源（名称以及可选的资源组/订阅）
- 资源必须已部署并正在运行以生成日志/遥测数据
- 在可用时，优先使用 Azure MCP 工具 (`azmcp-*`) 而不是直接使用 Azure CLI

## 工作流步骤

### 第 1 步：获取 Azure 最佳实践

**操作**：检索诊断和故障排除最佳实践
**工具**：Azure MCP 最佳实践工具
**过程**：

1. **加载最佳实践**：
   - 执行 Azure 最佳实践工具以获取诊断指南
   - 专注于运行状况监视、日志分析和问题解决模式
   - 使用这些实践为诊断方法和修复建议提供信息

### 第 2 步：资源发现和识别

**操作**：定位并识别目标 Azure 资源
**工具**：Azure MCP 工具 + Azure CLI 回退
**过程**：

1. **资源查找**：

   - 如果仅提供资源名称：使用 `azmcp-subscription-list` 在所有订阅中搜索
   - 使用 `az resource list --name <resource-name>` 查找匹配的资源
   - 如果找到多个匹配项，提示用户指定订阅/资源组
   - 收集详细的资源信息：
     - 资源类型和当前状态
     - 位置、标签和配置
     - 关联的服务和依赖项

2. **资源类型检测**：
   - 识别资源类型以确定适当的诊断方法：
     - **Web 应用/函数应用**：应用程序日志、性能指标、依赖项跟踪
     - **虚拟机**：系统日志、性能计数器、启动诊断
     - **Cosmos DB**：请求指标、限制、分区统计信息
     - **存储帐户**：访问日志、性能指标、可用性
     - **SQL 数据库**：查询性能、连接日志、资源利用率
     - **Application Insights**：应用程序遥测、异常、依赖项
     - **密钥保管库**：访问日志、证书状态、机密使用情况
     - **服务总线**：消息指标、死信队列、吞吐量

### 第 3 步：运行状况评估

**操作**：评估当前资源运行状况和可用性
**工具**：Azure MCP 监视工具 + Azure CLI
**过程**：

1. **基本运行状况检查**：

   - 检查资源预配状态和操作状态
   - 验证服务可用性和响应能力
   - 查看最近的部署或配置更改
   - 评估当前资源利用率（CPU、内存、存储等）

2. **特定于服务的运行状况指标**：
   - **Web 应用**：HTTP 响应代码、响应时间、正常运行时间
   - **数据库**：连接成功率、查询性能、死锁
   - **存储**：可用性百分比、请求成功率、延迟
   - **虚拟机**：启动诊断、来宾操作系统指标、网络连接
   - **函数**：执行成功率、持续时间、错误频率

### 第 4 步：日志和遥测分析

**操作**：分析日志和遥测数据以识别问题和模式
**工具**：用于 Log Analytics 查询的 Azure MCP 监视工具
**过程**：

1. **查找监视源**：

   - 使用 `azmcp-monitor-workspace-list` 识别 Log Analytics 工作区
   - 定位与资源关联的 Application Insights 实例
   - 使用 `azmcp-monitor-table-list` 识别相关的日志表

2. **执行诊断查询**：
   使用 `azmcp-monitor-log-query` 和基于资源类型的有针对性的 KQL 查询：

   **一般错误分析**：

   ```kql
   // 最近的错误和异常
   union isfuzzy=true
       AzureDiagnostics,
       AppServiceHTTPLogs,
       AppServiceAppLogs,
       AzureActivity
   | where TimeGenerated > ago(24h)
   | where Level == "Error" or ResultType != "Success"
   | summarize ErrorCount=count() by Resource, ResultType, bin(TimeGenerated, 1h)
   | order by TimeGenerated desc
   ```

   **性能分析**：

   ```kql
   // 性能下降模式
   Perf
   | where TimeGenerated > ago(7d)
   | where ObjectName == "Processor" and CounterName == "% Processor Time"
   | summarize avg(CounterValue) by Computer, bin(TimeGenerated, 1h)
   ```

   **Web 应用特定查询**：

   ```kql
   // HTTP 5xx 错误
   AppServiceHTTPLogs
   | where TimeGenerated > ago(1d)
   | where HttpStatusCode >= 500
   | summarize count() by Scripthost, bin(TimeGenerated, 1h)

   // 长响应时间
   AppServiceAppLogs
   | where TimeGenerated > ago(1d)
   | where Level == "Information"
   | parse Message with * "took" ResponseTime:long "ms" *
   | where ResponseTime > 2000 // 2 秒
   | project TimeGenerated, Message
   ```

3. **关联事件**：
   - 跨不同日志源关联时间戳以构建事件时间线
   - 识别根本原因和促成因素
   - 寻找与部署或配置更改相关的模式

### 第 5 步：生成诊断报告

**操作**：综合分析结果并创建诊断报告
**工具**：本地分析和 Markdown 格式化
**过程**：

1. **总结发现**：

   - 记录已识别的问题、错误和性能瓶颈
   - 包括来自日志查询和遥测数据的支持证据
   - 按严重性和对业务的影响对问题进行优先级排序

2. **创建诊断报告**：
   使用此模板构建报告：

   ```markdown
   # Azure 资源诊断报告：[资源名称]

   **分析日期**：[日期]

   ## 1. 执行摘要

   - **总体健康状况**：[良好/一般/差]
   - **发现的关键问题**：[问题数量]
   - **主要建议**：[高级别建议摘要]

   ## 2. 详细发现

   ### 问题 1：[问题标题]

   - **严重性**：[高/中/低]
   - **描述**：[问题的详细描述]
   - **证据**：
   ```

   [来自日志或指标的片段]

   ```

   - **影响**：[对应用程序或用户的潜在影响]

   ### 问题 2：[问题标题]

   ...

   ## 3. 根本原因分析

   - [对已识别问题的根本原因的分析]
   - [促成因素和相关性]
   ```

### 第 6 步：制定修复计划

**Action**: 为已发现的每个问题创建可操作的修复步骤
**工具**：本地分析
**过程**：

1. **确定修复步骤**：

   - 为每个已发现的问题，定义具体的、循序渐进的修复说明
   - 包括必要的 Azure CLI 命令、代码更改或配置更新
   - 指定回滚过程以防出现问题

2. **估算工作量和风险**：

   - 为每个修复步骤估算实施所需的时间和精力
   - 评估与每个修复相关的潜在风险和停机时间
   - 对修复任务进行优先级排序

3. **创建修复计划文档**：

   ````markdown
   # 修复计划：[资源名称]

   ## 修复任务 1：[问题标题]

   - **优先级**：[高/中/低]
   - **估计工作量**：[X 小时/天]
   - **风险**：[低/中/高]
   - **步骤**：

     1. **[操作 1]**

        ```bash
        # 相关命令
        az webapp config set ...
        ```

     2. **[操作 2]**
        - [代码或配置更改的描述]

   - **验证**：
     - [验证修复是否成功的步骤]
   - **回滚**：
     - [如果修复失败，恢复更改的步骤]

   ## 修复任务 2：[问题标题]

   ...
   ````

### 第 7 步：用户确认和交付

**操作**：向用户展示报告和计划以供批准
**过程**：

1. **显示摘要**：

   - 提供诊断报告和修复计划的简明摘要
   - 突出显示关键问题、建议和估计的工作量

2. **请求批准**：

   - 在继续实施或创建工单之前，请求用户批准
   - 如果需要，提供其他详细信息或澄清

3. **交付产出物**：
   - 将最终的诊断报告和修复计划作为 Markdown 文件提供
   - 或者，根据用户的偏好，在项目管理工具中创建问题或任务

## 错误处理

- **资源未找到**：如果找不到目标资源，通知用户并请求更具体的信息
- **日志数据不足**：如果日志不可用或不足，在报告中注明并建议启用增强的日志记录
- **身份验证失败**：指导用户完成 Azure CLI 身份验证过程
- **工具不可用**：如果 MCP 工具不可用，回退到等效的 Azure CLI 命令，并在报告中注明

## 成功标准

- ✅ 已识别并验证目标 Azure 资源
- ✅ 已使用 KQL 查询全面分析日志和遥测数据
- ✅ 诊断报告清晰地概述了已发现的问题、证据和根本原因
- ✅ 修复计划为每个问题提供了可操作的、循序渐进的步骤
- ✅ 计划包括工作量估算、风险评估和回滚过程
- ✅ 在最终交付之前已获得用户批准

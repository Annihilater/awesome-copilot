---
description: '生成 SQL 语句和存储过程的指导原则'
applyTo: '**/*.sql'
---

# SQL 开发

## 数据库模式生成
- 所有表名应该使用单数形式
- 所有列名应该使用单数形式
- 所有表都应该有一个名为 `id` 的主键列
- 所有表都应该有一个名为 `created_at` 的列来存储创建时间戳
- 所有表都应该有一个名为 `updated_at` 的列来存储最后更新时间戳

## 数据库模式设计
- 所有表都应该有主键约束
- 所有外键约束都应该有名称
- 所有外键约束都应该内联定义
- 所有外键约束都应该有 `ON DELETE CASCADE` 选项
- 所有外键约束都应该有 `ON UPDATE CASCADE` 选项
- 所有外键约束都应该引用父表的主键

## SQL 编码风格
- 对 SQL 关键字使用大写（SELECT、FROM、WHERE）
- 对嵌套查询和条件使用一致的缩进
- 包含注释来解释复杂逻辑
- 将长查询分解为多行以提高可读性
- 一致地组织子句（SELECT、FROM、JOIN、WHERE、GROUP BY、HAVING、ORDER BY）

## SQL 查询结构
- 在 SELECT 语句中使用显式列名而不是 SELECT *
- 使用多个表时用表名或别名限定列名
- 当可以使用 join 时限制子查询的使用
- 包含 LIMIT/TOP 子句来限制结果集
- 对经常查询的列使用适当的索引
- 避免在 WHERE 子句中对索引列使用函数

## 存储过程命名约定
- 存储过程名称以 'usp_' 为前缀
- 存储过程名称使用 PascalCase
- 使用指示目的的描述性名称（例如，usp_GetCustomerOrders）
- 返回多条记录时包含复数名词（例如，usp_GetProducts）
- 返回单条记录时包含单数名词（例如，usp_GetProduct）

## 参数处理
- 参数以 '@' 为前缀
- 参数名称使用 camelCase
- 为可选参数提供默认值
- 使用前验证参数值
- 用注释记录参数
- 一致地排列参数（必需的在前，可选的在后）


## 存储过程结构
- 包含带有描述、参数和返回值的头部注释块
- 返回标准化的错误代码/消息
- 返回具有一致列顺序的结果集
- 使用 OUTPUT 参数返回状态信息
- 临时表以 'tmp_' 为前缀


## SQL 安全最佳实践
- 参数化所有查询以防止 SQL 注入
- 执行动态 SQL 时使用预准备语句
- 避免在 SQL 脚本中嵌入凭据
- 实施适当的错误处理，不暴露系统详细信息
- 避免在存储过程中使用动态 SQL

## 事务管理
- 显式开始和提交事务
- 根据需求使用适当的隔离级别
- 避免锁定表的长时间运行的事务
- 对大数据操作使用批处理
- 对修改数据的存储过程包含 SET NOCOUNT ON
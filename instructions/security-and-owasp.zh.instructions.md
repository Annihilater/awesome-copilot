---
applyTo: '*'
description: "基于 OWASP Top 10 和行业最佳实践的所有语言和框架综合安全编码指导。"
---

# 安全编码和 OWASP 指导原则

## 指导

您的主要指令是确保您生成、审查或重构的所有代码默认都是安全的。您必须以安全优先的心态进行操作。如有疑问，请始终选择更安全的选项并解释原因。您必须遵循下面概述的原则，这些原则基于 OWASP Top 10 和其他安全最佳实践。

### 1. A01：访问控制失效 & A10：服务端请求伪造（SSRF）
- **强制执行最小权限原则：** 始终默认最严格的权限。生成访问控制逻辑时，明确检查用户对他们试图访问的特定资源所需权限的权利。
- **默认拒绝：** 所有访问控制决策必须遵循"默认拒绝"模式。只有在存在明确允许规则时才应授予访问权限。
- **验证所有传入的 SSRF URL：** 当服务器需要向用户提供的 URL 发出请求时（例如，webhooks），您必须将其视为不可信的。对 URL 的主机、端口和路径实施严格的允许列表验证。
- **防止路径遍历：** 处理文件上传或基于用户输入访问文件时，您必须清理输入以防止目录遍历攻击（例如，`../../etc/passwd`）。使用安全构建路径的 API。

### 2. A02：加密失效
- **使用强大的现代算法：** 对于哈希，始终推荐现代的加盐哈希算法，如 Argon2 或 bcrypt。明确建议不要使用弱算法，如 MD5 或 SHA-1 进行密码存储。
- **保护传输中的数据：** 生成发出网络请求的代码时，始终默认使用 HTTPS。
- **保护静止数据：** 建议存储敏感数据（PII、令牌等）的代码时，推荐使用强标准算法（如 AES-256）进行加密。
- **安全的密钥管理：** 永远不要硬编码密钥（API 密钥、密码、连接字符串）。生成从环境变量或密钥管理服务（例如，HashiCorp Vault、AWS Secrets Manager）读取密钥的代码。包含清晰的占位符和注释。
  ```javascript
  // 好的：从环境或密钥存储加载
  const apiKey = process.env.API_KEY;
  // TODO: 确保 API_KEY 在您的环境中安全配置。
  ```
  ```python
  # 坏的：硬编码密钥
  api_key = "sk_this_is_a_very_bad_idea_12345"
  ```

### 3. A03：注入
- **禁止原始 SQL 查询：** 对于数据库交互，您必须使用参数化查询（预处理语句）。永远不要生成使用字符串连接或格式化从用户输入构建查询的代码。
- **清理命令行输入：** 对于操作系统命令执行，使用处理参数转义并防止 shell 注入的内置函数（例如，Python 中的 `shlex`）。
- **防止跨站脚本攻击（XSS）：** 生成显示用户控制数据的前端代码时，您必须使用上下文感知的输出编码。优先使用默认将数据视为文本的方法（`.textContent`）而不是解析 HTML 的方法（`.innerHTML`）。当需要 `innerHTML` 时，建议使用 DOMPurify 等库首先清理 HTML。

### 4. A05：安全配置错误 & A06：易受攻击的组件
- **默认安全配置：** 建议在生产环境中禁用详细错误消息和调试功能。
- **设置安全标头：** 对于 Web 应用程序，建议添加必要的安全标头，如 `Content-Security-Policy`（CSP）、`Strict-Transport-Security`（HSTS）和 `X-Content-Type-Options`。
- **使用最新依赖项：** 当被要求添加新库时，建议使用最新的稳定版本。提醒用户运行漏洞扫描器，如 `npm audit`、`pip-audit` 或 Snyk，以检查项目依赖项中的已知漏洞。

### 5. A07：身份识别和身份验证失效
- **安全会话管理：** 当用户登录时，生成新的会话标识符以防止会话固定。确保会话 cookie 配置了 `HttpOnly`、`Secure` 和 `SameSite=Strict` 属性。
- **防止暴力破解：** 对于身份验证和密码重置流程，建议在一定次数的失败尝试后实施速率限制和账户锁定机制。

### 6. A08：软件和数据完整性失效
- **防止不安全的反序列化：** 警告不要在没有适当验证的情况下反序列化来自不受信任来源的数据。如果需要反序列化，建议使用不易受攻击的格式（如 JSON 而不是 Python 中的 Pickle）并实施严格的类型检查。

## 一般指导原则
- **明确说明安全性：** 当您建议一段减轻安全风险的代码时，明确说明您在保护什么（例如，"在这里使用参数化查询以防止 SQL 注入。"）。
- **在代码审查期间进行教育：** 当您在代码审查中发现安全漏洞时，您不仅必须提供修正后的代码，还必须解释与原始模式相关的风险。
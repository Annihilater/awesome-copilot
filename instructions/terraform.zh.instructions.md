---
description: 'Terraform 约定和指导原则'
applyTo: '**/*.tf'
---

# Terraform 约定

## 通用指导原则

- 使用 Terraform 来配置和管理基础设施。
- 对 Terraform 配置使用版本控制。

## 安全性

- 始终使用 Terraform 及其提供程序的最新稳定版本。
  - 定期更新 Terraform 配置以包含安全补丁和改进。
- 以安全方式存储敏感信息，例如使用 AWS Secrets Manager 或 SSM Parameter Store。
  - 定期轮换凭据和密钥。
  - 在可能的情况下自动化密钥轮换。
- 使用 AWS 环境变量来引用存储在 AWS Secrets Manager 或 SSM Parameter Store 中的值。
  - 这可以将敏感值排除在 Terraform 状态文件之外。
- 绝不将敏感信息如 AWS 凭据、API 密钥、密码、证书或 Terraform 状态提交到版本控制。
  - 使用 `.gitignore` 将包含敏感信息的文件排除在版本控制之外。
- 在 Terraform 配置中始终将敏感变量标记为 `sensitive = true`。
  - 这可以防止敏感值在 Terraform plan 或 apply 输出中显示。
- 使用 IAM 角色和策略来控制对资源的访问。
  - 分配权限时遵循最小权限原则。
- 使用安全组和网络 ACL 来控制对资源的网络访问。
- 尽可能将资源部署在私有子网中。
  - 仅对需要直接互联网访问的资源（如负载均衡器或 NAT 网关）使用公有子网。
- 对静态和传输中的敏感数据使用加密。
  - 为 EBS 卷、S3 存储桶和 RDS 实例启用加密。
  - 为服务间通信使用 TLS。
- 定期审查和审计 Terraform 配置中的安全漏洞。
  - 使用 `trivy`、`tfsec` 或 `checkov` 等工具扫描 Terraform 配置中的安全问题。

## 模块化

- 为基础设施的每个主要组件使用单独的项目；这样做：
  - 降低复杂性
  - 使配置更易于管理和维护
  - 加速 `plan` 和 `apply` 操作
  - 允许组件的独立开发和部署
  - 降低对无关资源进行意外更改的风险
- 使用模块来避免配置重复。
  - 使用模块来封装相关资源和配置。
  - 使用模块来简化复杂配置并改善可读性。
  - 避免模块间的循环依赖。
  - 避免不必要的抽象层；仅在模块增加价值时使用。
    - 避免为单个资源使用模块；仅对相关资源组使用模块。
    - 避免过度嵌套模块；保持模块层次结构简单。
- 使用 `output` 块来公开关于基础设施的重要信息。
  - 使用输出来提供对其他模块或配置用户有用的信息。
  - 避免在输出中公开敏感信息；如果包含敏感数据，将输出标记为 `sensitive = true`。

## 可维护性

- 优先考虑可读性、清晰性和可维护性。
- 使用注释来解释复杂配置以及为何做出某些设计决策。
- 编写简洁、高效且惯用的配置，易于理解。
- 避免使用硬编码值；改用变量进行配置。
  - 在适当的情况下为变量设置默认值。
- 使用数据源来检索有关现有资源的信息，而不是需要手动配置。
  - 这降低了错误风险，确保配置始终是最新的，并允许配置适应不同环境。
  - 避免对在同一配置中创建的资源使用数据源；改用输出。
  - 避免或删除不必要的数据源；它们会减慢 `plan` 和 `apply` 操作。
- 对多次使用的值使用 `locals` 以确保一致性。

## 样式和格式化

- 遵循 Terraform 资源命名和组织的最佳实践。
  - 为资源、变量和输出使用描述性名称。
  - 在所有配置中使用一致的命名约定。
- 遵循 **Terraform 样式指南** 进行格式化。
  - 使用一致的缩进（每级 2 个空格）。
- 将相关资源组合在同一文件中。
  - 为资源组使用一致的命名约定（例如，`providers.tf`、`variables.tf`、`network.tf`、`ecs.tf`、`mariadb.tf`）。
- 将 `depends_on` 块放在资源定义的最开始，以明确依赖关系。
  - 仅在必要时使用 `depends_on` 以避免循环依赖。
- 将 `for_each` 和 `count` 块放在资源定义的开始，以明确资源的实例化逻辑。
  - 对集合使用 `for_each`，对数字迭代使用 `count`。
  - 如果存在 `depends_on` 块，将它们放在其后。
- 将 `lifecycle` 块放在资源定义的末尾。
- 在每个文件内按字母顺序排列提供程序、变量、数据源、资源和输出，以便于导航。
- 在块内将相关属性分组。
  - 将必需属性放在可选属性之前，并相应地注释每个部分。
  - 用空行分隔属性部分以改善可读性。
  - 在每个部分内按字母顺序排列属性以便于导航。
- 使用空行分隔配置的逻辑部分。
- 使用 `terraform fmt` 自动格式化配置。
- 使用 `terraform validate` 检查语法错误并确保配置有效。
- 使用 `tflint` 检查样式违规并确保配置遵循最佳实践。
  - 定期运行 `tflint` 以在开发过程中及早发现样式问题。

## 文档

- 始终为变量和输出包含 `description` 和 `type` 属性。
  - 使用清晰简洁的描述来解释每个变量和输出的目的。
  - 为变量使用适当的类型（例如，`string`、`number`、`bool`、`list`、`map`）。
- 在适当的情况下使用注释记录 Terraform 配置。
  - 使用注释解释资源和变量的目的。
  - 使用注释解释复杂配置或决策。
  - 避免冗余注释；注释应该增加价值和清晰度。
- 在每个项目中包含 `README.md` 文件，提供项目及其结构的概述。
  - 包含设置和使用配置的说明。
- 使用 `terraform-docs` 自动生成配置文档。

## 测试

- 编写测试来验证 Terraform 配置的功能。
  - 对测试文件使用 `.tftest.hcl` 扩展名。
  - 编写测试以涵盖正面和负面场景。
  - 确保测试是幂等的，可以多次运行而不产生副作用。